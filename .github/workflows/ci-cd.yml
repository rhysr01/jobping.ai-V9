name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '18'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  # ===== QUALITY GATES =====
  quality-check:
    name: ðŸ” Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”¬ Run Biome linter
        run: npm run lint:biome

      - name: ðŸ” TypeScript type checking (production code only)
        run: npm run type-check:production

      - name: ðŸ§ª Run unit tests
        run: npm test

      - name: ðŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/

  # ===== SECURITY SCANNING =====
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run npm audit
        run: npm audit --audit-level high

      - name: ðŸ›¡ï¸ CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: ðŸš€ CodeQL Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” CodeQL Results
        uses: github/codeql-action/analyze@v3

  # ===== BUILD & TEST =====
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [quality-check]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_URL: "${{ secrets.NEXT_PUBLIC_BASE_URL }}"

      - name: ðŸ“Š Bundle analysis
        run: |
          echo "ðŸ“¦ Build artifacts:"
          du -sh .next/
          echo "ðŸ“„ Static files:"
          find .next/static -name "*.js" -exec wc -c {} \; | awk '{sum += $1} END {print "Total JS size: " sum/1024 " KB"}'

      - name: ðŸ§ª Quality Assurance Suite
        run: npm run test:quality-gate
        env:
          NEXT_PUBLIC_BASE_URL: "${{ secrets.NEXT_PUBLIC_BASE_URL }}"

      - name: ðŸ¤– MCP Test Analysis
        if: failure()
        run: |
          # Analyze test failures and create automated issues
          npm run test:failure-analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: ðŸ“Š Generate Test Health Report
        run: |
          # Generate comprehensive test health insights
          npm run test:health-dashboard

      - name: ðŸ“¸ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            !.next/cache/

  # ===== DEPLOYMENT =====
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-and-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        run: |
          # Install Vercel CLI
          npm i -g vercel

          # Deploy with environment variables
          DEPLOY_URL=$(vercel --prod --yes --token "${{ secrets.VERCEL_ACCESS_TOKEN }}" 2>&1 | grep -o 'https://[^"]*\.vercel\.app')

          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Deployed to: $DEPLOY_URL"

      - name: ðŸ” Health check
        run: |
          echo "â³ Waiting for deployment to be ready..."
          for i in {1..30}; do
            if curl -f -s "$DEPLOY_URL/api/health" > /dev/null 2>&1; then
              echo "âœ… Deployment is healthy!"
              break
            fi
            echo "â³ Attempt $i/30 - waiting..."
            sleep 10
          done

          # Final health check
          if ! curl -f -s "$DEPLOY_URL/api/health" > /dev/null 2>&1; then
            echo "âŒ Health check failed!"
            exit 1
          fi

  # ===== DEPLOYMENT MONITORING =====
  monitor-deployment:
    name: ðŸ‘€ Monitor Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run deployment monitoring
        run: npm run deploy:check
        env:
          VERCEL_ACCESS_TOKEN: "${{ secrets.VERCEL_ACCESS_TOKEN }}"
          VERCEL_TEAM_ID: "${{ secrets.VERCEL_TEAM_ID }}"

  # ===== POST-DEPLOYMENT TESTS =====
  post-deploy-tests:
    name: ðŸ§ª Post-Deploy Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ§ª Run smoke tests against production
        run: |
          DEPLOY_URL="${{ needs.deploy.outputs.url }}"
          echo "ðŸ§ª Testing production deployment: $DEPLOY_URL"

          # Test homepage
          if ! curl -f -s "$DEPLOY_URL" > /dev/null; then
            echo "âŒ Homepage test failed"
            exit 1
          fi

          # Test health endpoint
          if ! curl -f -s "$DEPLOY_URL/api/health" > /dev/null; then
            echo "âŒ Health check failed"
            exit 1
          fi

          # Test signup page
          if ! curl -f -s "$DEPLOY_URL/signup/free" > /dev/null; then
            echo "âŒ Signup page test failed"
            exit 1
          fi

          echo "âœ… All smoke tests passed!"

  # ===== PERFORMANCE MONITORING =====
  performance-check:
    name: ðŸ“Š Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“Š Lighthouse Performance Check
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: ${{ needs.deploy.outputs.url }}
          configPath: .lighthouserc.json
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ===== NOTIFICATION =====
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, build-and-test, deploy, post-deploy-tests, performance-check]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¢ Deployment Status Notification
        run: |
          DEPLOY_URL="${{ needs.deploy.outputs.url }}"
          STATUS="${{ needs.deploy.result }}"

          if [ "$STATUS" = "success" ]; then
            echo "ðŸŽ‰ Deployment successful!"
            echo "ðŸ”— $DEPLOY_URL"
            # Here you could add Slack/Discord notifications
          else
            echo "âŒ Deployment failed!"
            echo "ðŸ”— Check: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            # Here you could add failure notifications
          fi

      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.deploy.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality Gates:** ${{ needs.quality-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan:** ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build & Test:** ${{ needs.build-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Post-deploy:** ${{ needs.post-deploy-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** ${{ needs.performance-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY